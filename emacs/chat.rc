; chat.rc - microEmacs AI Chat Integration
;
; Usage:
;   1. Copy this file to your microEmacs directory
;   2. Add to your emacs.rc:  execute-file "chat.rc"
;   3. Use ESC a to ask AI a question
;
; Commands:
;   ESC a     - Ask AI (input in minibuffer, insert response)
;   ESC A     - Filter region through AI (replace with response)
;   ^C ^S     - Same as ESC a

; Ask AI - input question in minibuffer, insert response at cursor
store-procedure "ask-ai"
    ; Get question from minibuffer
    set %query @"Ask AI: "
    !if &equal %query ""
        !return
    !endif
    ; Remember current buffer name
    set %oldbuf $cbufname
    ; Show question in original buffer
    insert-string "~n> "
    insert-string %query
    insert-string "~n~n"
    ; Build command string
    set %cmd &cat "CHAT " %query
    ; Execute CHAT - this creates a new buffer with output
    pipe-command %cmd
    ; Select all content in command output buffer
    beginning-of-file
    set-mark
    end-of-file
    ; Copy to kill buffer
    copy-region
    ; Switch back to original buffer
    select-buffer %oldbuf
    ; Paste the response
    yank
    insert-string "~n"
    ; Clean up: delete the command output buffer and restore single window
    delete-buffer "*pipe*"
    delete-other-windows
!endm

; Ask AI about region - use filter-buffer to process selection
; Note: This replaces the selected text with AI response
; If filter-buffer is not available, use manual workflow:
;   1. Save buffer to file (Ctrl-X Ctrl-S)
;   2. Run: CHAT <filename.txt
store-procedure "ask-ai-region"
    ; Filter selected region through CHAT command
    ; This sends region content to CHAT and replaces with output
    filter-buffer "CHAT"
!endm

; Bind keys
bind-to-key execute-procedure "ask-ai" M-a
bind-to-key execute-procedure "ask-ai-region" M-A
bind-to-key execute-procedure "ask-ai" ^C^S
